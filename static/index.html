<!DOCTYPE html>
<html lang=en>
<meta charset="utf-8">
<title>Resa 3T</title>
<meta name=description content="Planning Management">
<meta name=viewport content="width=device-width,initial-scale=1.0">
<link rel=apple-touch-icon href="/static/logo.png">
<meta name=theme-color content="#065b9d">
<!--link rel=manifest href="manifest.json"-->
<link rel=icon href="data:;base64,iVBORw0KGgo=">
<link rel=stylesheet href="https://unpkg.com/chota@0.7.1/dist/chota.min.css">
<style></style>

<main>
    <nav class="tabs content hide-pr">
        <img src=/static/logo.svg width=42 class=brand alt=logo hidden>
        <a is=router-link :to="{name:'PlayList'}" exact>Planning</a>
        <a is=router-link :to="{name:'UserList'}">Users</a>
        <a is=router-link :to="{name:'PieceList'}">Piece</a>
        <details class="dropdown">
            <summary class="button clear">Login</summary>
            <form class="card row">
                <a is=router-link :to="{name:'User', params:{id:$auth.get.name}}">My profile</a>
                <input class="col-12" placeholder="username">
                <input class="col-12" placeholder="password" type="password">
                <footer class="is-right">
                    <a class="button clear">Sign up</a>
                    <button type="submit">Sign in</button>
                </footer>
            </form>
        </details>
    </nav>
    <transition name=trans mode=out-in>
        <router-view class=container>
    </transition>
    <Km-Toaster />
</main>

<script src="https://unpkg.com/vue@2.6.10/dist/vue.min.js"></script>
<script src="https://unpkg.com/vue-router@3.1.3/dist/vue-router.min.js"></script>
<script type=module>
const PlayList = {
    template:`<div class=row>
        <a class="card col-4" is=router-link :to="{name:'PieceNew'}">Create</a>
        <div class="card col-4" v-for="p in plays">
            <a is=router-link :to="{name:'PieceForm', params:{id:p.piece_id}}">{{p.piece_id}}</a>
            {{p.date}} {{p.time}}
            <span v-for="a in p.actors">@{{a}} </span>
        </div>
        </div>`,
    data(){return {plays:[]}},
    async mounted(){
        this.plays = await this.rest('/play')
    }
}

const UserList = {
    template:`<div class=row>
        <p class="card col-3" v-for="user in users">
            <a is=router-link :to="{name:'UserForm', params:{id:user.id}}">{{user.id}}</a>
        </p>
    </div>`,
    data(){return {users:[]}},
    async mounted(){
        this.users = await this.rest('/actor')
    }
}
const PieceList = {
    template:`
    <p class="card col-4" v-for="piece in pieces">
        <a is=router-link :to="{name:'PieceForm', params:{id:piece.id}}">{{piece.id}}</a>
        <ul>
            <li v-for="(users,role) in piece.roles">{{role}}:
                <a v-for="(user,pos) in users" is=router-link :to="{name:'UserForm', params:{id:user}}">{{user}} </a>
            </li>
        </ul>
    </p>`,
    data(){return {pieces:[]}},
    async mounted() {
        this.pieces = await this.rest('/piece');
    }
}

const UserForm = {
    template:`<form action=/user>
        <input name=user placeholder=username>
        <input name=pass placeholder=password type=password>
        <input type=submit>
    </form>`,
    data(){return {pieces:[]}},
    async mounted() {
        this.pieces = await this.rest('/piece');
    }
}

const PlayForm = {
    template:`<form action=/play>
        <input name=piece_id>
        <input name=date>
        <textarea name=actors> role=>actor_id </textarea>
        <input type=submit>
    </form>`
}

const PieceForm = {
    template:`<p class="card col-4">TODO</p>`,
}

import {$auth, $rest, $toaster} from 'https://unpkg.com/vue-authfetch@0.0.4/index.js'
/*
import PagePlanning  from '/static/PagePlanning.js'
import PageSign      from '/static/PageSign.js'
import PageActivity  from '/static/PageActivity.js'
import UserList      from '/static/UserList.js'
*/

const app = new Vue({
	el: 'main',
	components: { KmToaster: $toaster },
	router: new VueRouter({
		linkActiveClass:'active',
		mode: 'history',
		routes: [
			{ path:'/', name: "Planning", component: PlayList },
			{ path:'/play/', name: "PlayList", component: PlayList},
			{ path:'/play/new', name: "PlayNew", component: PlayForm},
			{ path:'/play/:id', name: "PlayForm", component: PlayForm, props: true },
			{ path:'/piece/', name: "PieceList", component: PieceList},
			{ path:'/piece/new', name: "PieceNew", component: PieceForm},
			{ path:'/piece/:id', name: "PieceForm", component: PieceForm, props: true },
			{ path:'/user/', name: "UserList", component: UserList},
			{ path:'/user/new', name: "UserNew", component: UserForm, props: { edit: true }},
			{ path:'/user/:id', name: "UserForm", component: UserForm, props: true },
			//{ path:'/sign/', name: "Sign", component: PageSign},
		]
	}),
})

if ('serviceWorker' in navigator) {
//	navigator.serviceWorker.register('/km/sw.js', {scope: '/km/'}).then(console.log);
}
//*/
</script>
